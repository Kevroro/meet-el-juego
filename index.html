<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Meet - Experience</title>
    
    <!-- Favicons y Manifest -->
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon2.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Caveat&family=Comfortaa:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root { --bg-dark: #000000; }
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; background-color: var(--bg-dark); overflow: hidden; position: fixed; }
        body { font-family: 'Comfortaa', sans-serif; -webkit-tap-highlight-color: transparent; display: flex; flex-direction: column; }
        .font-caveat { font-family: 'Caveat', cursive; }
        .question-box { background: linear-gradient(145deg, #0d1e75, #9a18a4); min-height: 42vh; display: flex; flex-direction: column; justify-content: center; transition: all 0.3s ease; }
        @keyframes zoomIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        .animate-zoom-in { animation: zoomIn 0.3s ease-out forwards; }
        .hidden { display: none !important; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .safe-pt { padding-top: env(safe-area-inset-top); }
        .mood-card { transition: all 0.2s ease; border: 1px solid rgba(255,255,255,0.1); }
        .mood-card.selected { border-color: #fff; background: rgba(255,255,255,0.1); transform: scale(1.05); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="text-white">

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 flex items-center justify-center bg-white z-50 transition-opacity duration-500">
        <div class="flex flex-col items-center text-center px-6">
             <div class="w-32 h-32 mb-6 flex items-center justify-center">
                <img id="splash-logo" src="logoblanco.png" alt="MEET" class="max-w-full max-h-full object-contain" 
                     onerror="this.onerror=null; this.src='logo.png'; this.parentElement.innerHTML='<div class=\'w-24 h-24 bg-black rounded-full flex items-center justify-center text-white font-bold animate-pulse text-2xl\'>MEET</div>'">
             </div>
             <p id="splash-text" class="text-black font-caveat text-3xl">Cargando cat√°logo...</p>
        </div>
    </div>

    <!-- Lobby -->
    <div id="lobby-setup" class="hidden fixed inset-0 flex flex-col items-center justify-center p-6 z-40 animate-zoom-in safe-pt safe-pb overflow-y-auto">
        <div class="mb-6 flex flex-col items-center">
            <img src="logo.png" class="h-24 w-auto mb-2" alt="Logo Meet" onerror="this.style.display='none'">
            <h1 class="text-6xl font-caveat text-center text-white">MEET</h1>
        </div>
        
        <div class="w-full max-w-xs space-y-4">
            <input id="user-nickname" type="text" class="w-full bg-white/10 text-white px-6 py-4 rounded-2xl border border-white/20 text-center outline-none focus:border-purple-500 transition-colors" placeholder="Tu apodo">
            
            <div id="mood-selector" class="grid grid-cols-4 gap-2">
                <button onclick="selectMood('chill', this)" class="mood-card selected p-2 rounded-xl flex flex-col items-center">
                    <span class="text-lg">‚ù§Ô∏è</span>
                    <span class="text-[7px] mt-1 uppercase opacity-60">Chill</span>
                </button>
                <button onclick="selectMood('hot', this)" class="mood-card p-2 rounded-xl flex flex-col items-center">
                    <span class="text-lg">üî•</span>
                    <span class="text-[7px] mt-1 uppercase opacity-60">Hot</span>
                </button>
                <button onclick="selectMood('psycho', this)" class="mood-card p-2 rounded-xl flex flex-col items-center">
                    <span class="text-lg">üß†</span>
                    <span class="text-[7px] mt-1 uppercase opacity-60">Psycho</span>
                </button>
                <button onclick="selectMood('mix', this)" class="mood-card p-2 rounded-xl flex flex-col items-center">
                    <span class="text-lg">üåÄ</span>
                    <span class="text-[7px] mt-1 uppercase opacity-60">Mix</span>
                </button>
            </div>

            <div class="pt-2 space-y-3">
                <button id="btn-create-room" class="w-full bg-white text-black py-4 rounded-2xl font-bold active:scale-95 shadow-lg uppercase text-[10px] tracking-[0.2em]">Crear Sala</button>
                <div class="flex items-center py-2 opacity-20"><div class="flex-grow border-t border-white"></div><span class="mx-4 text-[10px]">O</span><div class="flex-grow border-t border-white"></div></div>
                <div class="flex flex-col space-y-2">
                    <input id="room-id-input" type="text" maxlength="4" class="w-full bg-white/5 text-white px-4 py-4 rounded-2xl border border-white/10 uppercase outline-none text-center font-bold tracking-[0.4em]" placeholder="C√ìDIGO">
                    <button id="btn-join-room" class="w-full bg-indigo-600/50 py-4 rounded-2xl font-bold active:scale-95 border border-indigo-400/20 uppercase text-[10px] tracking-[0.2em]">Unirse</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla de Juego -->
    <div id="game-screen" class="hidden fixed inset-0 flex flex-col justify-between items-center py-6 px-4 z-30 safe-pt safe-pb bg-black">
        <div class="w-full flex justify-between items-center px-4">
            <button onclick="window.location.reload()" class="text-white/20 uppercase text-[10px] tracking-widest font-bold">Salir</button>
            <div id="display-room-id" class="text-[10px] font-bold bg-white/5 px-4 py-2 rounded-full border border-white/10 text-purple-400 tracking-[0.2em]">----</div>
        </div>
        <div id="turn-indicator" class="text-[10px] uppercase tracking-[0.3em] font-bold text-white/40 bg-white/5 px-6 py-2 rounded-full border border-white/5">Esperando...</div>
        <div id="q-container" class="question-box w-full max-w-sm p-8 rounded-[3rem] shadow-2xl text-center relative mx-4 border border-white/10">
            <div id="emoji" class="text-6xl mb-6 drop-shadow-lg">‚ú®</div>
            <div class="flex-1 flex items-center justify-center min-h-[140px]">
                <p id="question" class="text-2xl md:text-3xl font-caveat leading-tight px-2 text-white">¬°Bienvenido!</p>
            </div>
            <div id="host-controls" class="mt-8 hidden flex flex-col items-center space-y-4">
                <button id="new-question" class="bg-white text-black font-bold py-4 px-10 rounded-full shadow-2xl active:scale-90 text-[9px] tracking-[0.2em]">SIGUIENTE PREGUNTA</button>
            </div>
        </div>
        <div id="player-scores" class="w-full max-w-sm space-y-3 overflow-y-auto max-h-[25vh] mt-8 px-2 scrollbar-hide"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const splash = document.getElementById('splash-screen');
        const lobby = document.getElementById('lobby-setup');

        const hideSplash = () => {
            splash.classList.add('opacity-0');
            setTimeout(() => {
                splash.classList.add('hidden');
                lobby.classList.remove('hidden');
            }, 500);
        };

        // Forzamos entrada en 3 segundos si Firebase no responde
        setTimeout(hideSplash, 3000);

        let config = null;
        try {
            // Buscamos la config en las variables globales que inyecta el entorno
            if (typeof __firebase_config !== 'undefined') {
                config = JSON.parse(__firebase_config);
            }
        } catch (e) {
            console.error("Config error:", e);
        }

        if (config) {
            const app = initializeApp(config);
            const db = getFirestore(app);
            const auth = getAuth(app);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'meet-app-v1';

            let currentRoomId = null, currentUser = null, isHost = false, selectedMood = 'chill', unsubscribeRoom = null;

            const QUESTIONS = {
                chill: [{text: "¬øCu√°l es tu mejor recuerdo de infancia?", emoji: "‚ù§Ô∏è"}, {text: "¬øQu√© viaje repetir√≠as mil veces?", emoji: "‚úàÔ∏è"}],
                hot: [{text: "¬øQu√© es lo m√°s atrevido que has hecho?", emoji: "üî•"}, {text: "¬øCu√°l es tu mayor fantas√≠a?", emoji: "üî•"}],
                psycho: [{text: "¬øQu√© har√≠as si fueras invisible un d√≠a?", emoji: "üß†"}, {text: "¬øCu√°l es tu mayor miedo?", emoji: "üß†"}],
                mix: []
            };

            window.selectMood = (mood, el) => {
                selectedMood = mood;
                document.querySelectorAll('.mood-card').forEach(c => c.classList.remove('selected'));
                el.classList.add('selected');
            };

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    hideSplash();
                } else {
                    signInAnonymously(auth).catch(hideSplash);
                }
            });

            document.getElementById('btn-create-room').onclick = async () => {
                const name = document.getElementById('user-nickname').value.trim();
                if (!name || !currentUser) return;
                isHost = true;
                currentRoomId = Math.random().toString(36).substring(2, 6).toUpperCase();
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
                await setDoc(roomRef, {
                    host: currentUser.uid,
                    mood: selectedMood,
                    currentQuestion: { text: "Pulsa Siguiente para empezar", emoji: "‚ú®" },
                    players: [{ uid: currentUser.uid, name, score: 0 }],
                    turnIndex: 0
                });
                startRoomListener(db, appId);
            };

            document.getElementById('btn-join-room').onclick = async () => {
                const name = document.getElementById('user-nickname').value.trim();
                const roomId = document.getElementById('room-id-input').value.toUpperCase().trim();
                if (!name || !roomId || !currentUser) return;
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                const snap = await getDoc(roomRef);
                if (snap.exists()) {
                    currentRoomId = roomId;
                    isHost = snap.data().host === currentUser.uid;
                    await updateDoc(roomRef, { players: arrayUnion({ uid: currentUser.uid, name, score: 0 }) });
                    startRoomListener(db, appId);
                }
            };

            function startRoomListener(db, appId) {
                document.getElementById('lobby-setup').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                document.getElementById('display-room-id').innerText = currentRoomId;
                if (isHost) document.getElementById('host-controls').classList.remove('hidden');

                unsubscribeRoom = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId), (s) => {
                    const d = s.data();
                    if (!d) return;
                    const turnPlayer = d.players[d.turnIndex % d.players.length];
                    document.getElementById('turn-indicator').innerText = turnPlayer.uid === currentUser.uid ? "TU TURNO" : `TURNO: ${turnPlayer.name}`;
                    document.getElementById('question').innerText = d.currentQuestion.text;
                    document.getElementById('emoji').innerText = d.currentQuestion.emoji;
                    updateScores(d.players, db, appId);
                });
            }

            function updateScores(players, db, appId) {
                document.getElementById('player-scores').innerHTML = players.map(p => `
                    <div class="bg-white/5 p-4 rounded-2xl border ${p.uid === currentUser.uid ? 'border-purple-500' : 'border-white/5'}">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] font-bold uppercase tracking-widest">${p.name}</span>
                            <div class="flex items-center space-x-3">
                                ${p.uid === currentUser.uid ? `<button data-val="-5" class="score-adj text-lg opacity-40">Ôºç</button>
                                <span class="text-lg font-bold">${p.score}</span>
                                <button data-val="5" class="score-adj text-lg text-purple-400">Ôºã</button>` : `<span class="text-lg">${p.score}</span>`}
                            </div>
                        </div>
                        <div class="w-full bg-white/5 h-1 rounded-full"><div class="bg-purple-500 h-full transition-all" style="width:${p.score}%"></div></div>
                    </div>
                `).join('');
                document.querySelectorAll('.score-adj').forEach(b => {
                    b.onclick = () => changeScore(parseInt(b.dataset.val), db, appId);
                });
            }

            async function changeScore(v, db, appId) {
                const r = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
                const snap = await getDoc(r);
                const players = snap.data().players.map(p => {
                    if(p.uid === currentUser.uid) p.score = Math.max(0, Math.min(100, p.score + v));
                    return p;
                });
                await updateDoc(r, { players });
            }

            document.getElementById('new-question').onclick = async () => {
                const r = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
                const snap = await getDoc(r);
                const pool = QUESTIONS[snap.data().mood] || QUESTIONS.chill;
                const q = pool[Math.floor(Math.random() * pool.length)];
                await updateDoc(r, { currentQuestion: q, turnIndex: snap.data().turnIndex + 1 });
            };
        } else {
            // Si no hay config, forzamos el paso al lobby para que al menos veas el dise√±o
            setTimeout(hideSplash, 1000);
        }
    </script>
</body>
</html>
